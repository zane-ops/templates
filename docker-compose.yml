x-zane-env:
  TYPESENSE_API_KEY: "{{ generate_password | 32 }}"
  TYPESENSE_ENABLE_CORS: "true"
  MAIN_DOMAIN: "{{ generate_domain }}"

version: "3.8"
services:
  typesense:
    image: typesense/typesense:29.0
    restart: unless-stopped
    environment:
      - TYPESENSE_API_KEY=${TYPESENSE_API_KEY:-typesense}
      - TYPESENSE_ENABLE_CORS=${TYPESENSE_ENABLE_CORS:-true}
      - TYPESENSE_DATA_DIR=/data
    volumes:
      - typesense-data:/data

  proxy:
    image: caddy:2-alpine
    configs:
      - source: caddyfile
        target: /etc/caddy/Caddyfile
    deploy:
      labels:
        zane.http.routes.0.domain: ${MAIN_DOMAIN}
        zane.http.routes.0.port: 80

volumes:
  typesense-data:
configs:
  caddyfile:
    content: |
      :{$PORT:80} {
        reverse_proxy localhost:3000

        header {
          Access-Control-Allow-Origin *
          Access-Control-Allow-Methods "GET, POST, PUT, PATCH, DELETE, OPTIONS"
          Access-Control-Allow-Headers "Content-Type, Authorization, Accept"
          Access-Control-Max-Age 86400
        }

        @options method OPTIONS
        respond @options 204
      }
