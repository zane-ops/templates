version: "3.8"
x-zane-env:
  main_domain: "{{ generate_domain }}"
  _APP_ENV: production
  _APP_LOCALE: en
  _APP_OPTIONS_ABUSE: enabled
  _APP_OPTIONS_FORCE_HTTPS: disabled
  _APP_OPTIONS_FUNCTIONS_FORCE_HTTPS: disabled
  _APP_OPTIONS_ROUTER_PROTECTION: disabled
  _APP_OPENSSL_KEY_V1: your-secret-key
  _APP_DOMAIN: ${main_domain}
  _APP_DOMAIN_FUNCTIONS: ${main_domain}
  _APP_DOMAIN_TARGET: ${main_domain}
  _APP_CONSOLE_WHITELIST_ROOT: enabled
  _APP_CONSOLE_WHITELIST_EMAILS: ""
  _APP_CONSOLE_WHITELIST_IPS: ""
  _APP_CONSOLE_HOSTNAMES: ""
  _APP_SYSTEM_EMAIL_NAME: Appwrite
  _APP_SYSTEM_EMAIL_ADDRESS: noreply@appwrite.io
  _APP_SYSTEM_TEAM_EMAIL: team@appwrite.io
  _APP_SYSTEM_RESPONSE_FORMAT: ""
  _APP_SYSTEM_SECURITY_EMAIL_ADDRESS: certs@appwrite.io
  _APP_EMAIL_SECURITY: ""
  _APP_EMAIL_CERTIFICATES: ""
  _APP_USAGE_STATS: enabled
  _APP_LOGGING_PROVIDER: ""
  _APP_LOGGING_CONFIG: ""
  _APP_USAGE_AGGREGATION_INTERVAL: "30"
  _APP_USAGE_TIMESERIES_INTERVAL: "30"
  _APP_USAGE_DATABASE_INTERVAL: "900"
  _APP_WORKER_PER_CORE: "6"
  _APP_CONSOLE_SESSION_ALERTS: disabled
  _APP_REDIS_HOST: redis
  _APP_REDIS_PORT: "6379"
  _APP_REDIS_USER: ""
  _APP_REDIS_PASS: ""
  _APP_DB_HOST: mariadb
  _APP_DB_PORT: "3306"
  _APP_DB_SCHEMA: appwrite
  _APP_DB_USER: user
  _APP_DB_PASS: password
  _APP_DB_ROOT_PASS: rootsecretpassword
  _APP_INFLUXDB_HOST: influxdb
  _APP_INFLUXDB_PORT: "8086"
  _APP_STATSD_HOST: telegraf
  _APP_STATSD_PORT: "8125"
  _APP_SMTP_HOST: ""
  _APP_SMTP_PORT: ""
  _APP_SMTP_SECURE: ""
  _APP_SMTP_USERNAME: ""
  _APP_SMTP_PASSWORD: ""
  _APP_SMS_PROVIDER: ""
  _APP_SMS_FROM: ""
  _APP_STORAGE_LIMIT: "30000000"
  _APP_STORAGE_PREVIEW_LIMIT: "20000000"
  _APP_STORAGE_ANTIVIRUS: disabled
  _APP_STORAGE_ANTIVIRUS_HOST: clamav
  _APP_STORAGE_ANTIVIRUS_PORT: "3310"
  _APP_STORAGE_DEVICE: local
  _APP_STORAGE_S3_ACCESS_KEY: ""
  _APP_STORAGE_S3_SECRET: ""
  _APP_STORAGE_S3_REGION: us-east-1
  _APP_STORAGE_S3_BUCKET: ""
  _APP_STORAGE_DO_SPACES_ACCESS_KEY: ""
  _APP_STORAGE_DO_SPACES_SECRET: ""
  _APP_STORAGE_DO_SPACES_REGION: us-east-1
  _APP_STORAGE_DO_SPACES_BUCKET: ""
  _APP_STORAGE_BACKBLAZE_ACCESS_KEY: ""
  _APP_STORAGE_BACKBLAZE_SECRET: ""
  _APP_STORAGE_BACKBLAZE_REGION: us-west-004
  _APP_STORAGE_BACKBLAZE_BUCKET: ""
  _APP_STORAGE_LINODE_ACCESS_KEY: ""
  _APP_STORAGE_LINODE_SECRET: ""
  _APP_STORAGE_LINODE_REGION: eu-central-1
  _APP_STORAGE_LINODE_BUCKET: ""
  _APP_STORAGE_WASABI_ACCESS_KEY: ""
  _APP_STORAGE_WASABI_SECRET: ""
  _APP_STORAGE_WASABI_REGION: eu-central-1
  _APP_STORAGE_WASABI_BUCKET: ""
  _APP_FUNCTIONS_SIZE_LIMIT: "30000000"
  _APP_FUNCTIONS_BUILD_SIZE_LIMIT: "2000000000"
  _APP_FUNCTIONS_TIMEOUT: "900"
  _APP_FUNCTIONS_BUILD_TIMEOUT: "900"
  _APP_FUNCTIONS_CONTAINERS: "10"
  _APP_FUNCTIONS_CPUS: "0"
  _APP_FUNCTIONS_MEMORY: "0"
  _APP_FUNCTIONS_MEMORY_SWAP: "0"
  _APP_FUNCTIONS_RUNTIMES: node-16.0,php-8.0,python-3.9,ruby-3.0
  _APP_EXECUTOR_SECRET: your-secret-key
  _APP_EXECUTOR_HOST: http://exc1/v1
  _APP_EXECUTOR_RUNTIME_NETWORK: appwrite_runtimes
  _APP_FUNCTIONS_ENVS: node-16.0,php-7.4,python-3.9,ruby-3.0
  _APP_FUNCTIONS_INACTIVE_THRESHOLD: "60"
  DOCKERHUB_PULL_USERNAME: ""
  DOCKERHUB_PULL_PASSWORD: ""
  DOCKERHUB_PULL_EMAIL: ""
  OPEN_RUNTIMES_NETWORK: appwrite_runtimes
  _APP_FUNCTIONS_RUNTIMES_NETWORK: runtimes
  _APP_DOCKER_HUB_USERNAME: ""
  _APP_DOCKER_HUB_PASSWORD: ""
  _APP_FUNCTIONS_MAINTENANCE_INTERVAL: "3600"
  _APP_VCS_GITHUB_APP_NAME: ""
  _APP_VCS_GITHUB_PRIVATE_KEY: ""
  _APP_VCS_GITHUB_APP_ID: ""
  _APP_VCS_GITHUB_CLIENT_ID: ""
  _APP_VCS_GITHUB_CLIENT_SECRET: ""
  _APP_VCS_GITHUB_WEBHOOK_SECRET: ""
  _APP_MAINTENANCE_INTERVAL: "86400"
  _APP_MAINTENANCE_DELAY: "0"
  _APP_MAINTENANCE_RETENTION_CACHE: "2592000"
  _APP_MAINTENANCE_RETENTION_EXECUTION: "1209600"
  _APP_MAINTENANCE_RETENTION_AUDIT: "1209600"
  _APP_MAINTENANCE_RETENTION_ABUSE: "86400"
  _APP_MAINTENANCE_RETENTION_USAGE_HOURLY: "8640000"
  _APP_MAINTENANCE_RETENTION_SCHEDULES: "86400"
  _APP_GRAPHQL_MAX_BATCH_SIZE: "10"
  _APP_GRAPHQL_MAX_COMPLEXITY: "250"
  _APP_GRAPHQL_MAX_DEPTH: "3"
  _APP_MIGRATIONS_FIREBASE_CLIENT_ID: ""
  _APP_MIGRATIONS_FIREBASE_CLIENT_SECRET: ""
  _APP_ASSISTANT_OPENAI_API_KEY: ""

x-logging: &logging
  driver: json-file
  options:
    max-file: "5"
    max-size: 10m

# Common environment sections
x-env-core: &env-core
  _APP_ENV: ${_APP_ENV}
  _APP_WORKER_PER_CORE: ${_APP_WORKER_PER_CORE}
  _APP_OPENSSL_KEY_V1: ${_APP_OPENSSL_KEY_V1}
  _APP_REDIS_HOST: ${_APP_REDIS_HOST}
  _APP_REDIS_PORT: ${_APP_REDIS_PORT}
  _APP_REDIS_USER: ${_APP_REDIS_USER}
  _APP_REDIS_PASS: ${_APP_REDIS_PASS}
  _APP_DB_HOST: ${_APP_DB_HOST}
  _APP_DB_PORT: ${_APP_DB_PORT}
  _APP_DB_SCHEMA: ${_APP_DB_SCHEMA}
  _APP_DB_USER: ${_APP_DB_USER}
  _APP_DB_PASS: ${_APP_DB_PASS}

x-env-core-storage: &env-core-storage
  <<: *env-core
  _APP_STORAGE_DEVICE: ${_APP_STORAGE_DEVICE}
  _APP_STORAGE_S3_ACCESS_KEY: ${_APP_STORAGE_S3_ACCESS_KEY}
  _APP_STORAGE_S3_SECRET: ${_APP_STORAGE_S3_SECRET}
  _APP_STORAGE_S3_REGION: ${_APP_STORAGE_S3_REGION}
  _APP_STORAGE_S3_BUCKET: ${_APP_STORAGE_S3_BUCKET}
  _APP_STORAGE_DO_SPACES_ACCESS_KEY: ${_APP_STORAGE_DO_SPACES_ACCESS_KEY}
  _APP_STORAGE_DO_SPACES_SECRET: ${_APP_STORAGE_DO_SPACES_SECRET}
  _APP_STORAGE_DO_SPACES_REGION: ${_APP_STORAGE_DO_SPACES_REGION}
  _APP_STORAGE_DO_SPACES_BUCKET: ${_APP_STORAGE_DO_SPACES_BUCKET}
  _APP_STORAGE_BACKBLAZE_ACCESS_KEY: ${_APP_STORAGE_BACKBLAZE_ACCESS_KEY}
  _APP_STORAGE_BACKBLAZE_SECRET: ${_APP_STORAGE_BACKBLAZE_SECRET}
  _APP_STORAGE_BACKBLAZE_REGION: ${_APP_STORAGE_BACKBLAZE_REGION}
  _APP_STORAGE_BACKBLAZE_BUCKET: ${_APP_STORAGE_BACKBLAZE_BUCKET}
  _APP_STORAGE_LINODE_ACCESS_KEY: ${_APP_STORAGE_LINODE_ACCESS_KEY}
  _APP_STORAGE_LINODE_SECRET: ${_APP_STORAGE_LINODE_SECRET}
  _APP_STORAGE_LINODE_REGION: ${_APP_STORAGE_LINODE_REGION}
  _APP_STORAGE_LINODE_BUCKET: ${_APP_STORAGE_LINODE_BUCKET}
  _APP_STORAGE_WASABI_ACCESS_KEY: ${_APP_STORAGE_WASABI_ACCESS_KEY}
  _APP_STORAGE_WASABI_SECRET: ${_APP_STORAGE_WASABI_SECRET}
  _APP_STORAGE_WASABI_REGION: ${_APP_STORAGE_WASABI_REGION}
  _APP_STORAGE_WASABI_BUCKET: ${_APP_STORAGE_WASABI_BUCKET}

x-env-console: &env-console
  <<: *env-core-storage
  _APP_LOCALE: ${_APP_LOCALE}
  _APP_CONSOLE_WHITELIST_ROOT: ${_APP_CONSOLE_WHITELIST_ROOT}
  _APP_CONSOLE_WHITELIST_EMAILS: ${_APP_CONSOLE_WHITELIST_EMAILS}
  _APP_CONSOLE_SESSION_ALERTS: ${_APP_CONSOLE_SESSION_ALERTS}
  _APP_CONSOLE_WHITELIST_IPS: ${_APP_CONSOLE_WHITELIST_IPS}
  _APP_CONSOLE_HOSTNAMES: ${_APP_CONSOLE_HOSTNAMES}
  _APP_SYSTEM_EMAIL_NAME: ${_APP_SYSTEM_EMAIL_NAME}
  _APP_SYSTEM_EMAIL_ADDRESS: ${_APP_SYSTEM_EMAIL_ADDRESS}
  _APP_EMAIL_SECURITY: ${_APP_EMAIL_SECURITY}
  _APP_SYSTEM_RESPONSE_FORMAT: ${_APP_SYSTEM_RESPONSE_FORMAT}
  _APP_OPTIONS_ABUSE: ${_APP_OPTIONS_ABUSE}
  _APP_OPTIONS_ROUTER_PROTECTION: ${_APP_OPTIONS_ROUTER_PROTECTION}
  _APP_OPTIONS_FORCE_HTTPS: ${_APP_OPTIONS_FORCE_HTTPS}
  _APP_OPTIONS_FUNCTIONS_FORCE_HTTPS: ${_APP_OPTIONS_FUNCTIONS_FORCE_HTTPS}
  _APP_DOMAIN: ${_APP_DOMAIN}
  _APP_DOMAIN_TARGET: ${_APP_DOMAIN_TARGET}
  _APP_DOMAIN_FUNCTIONS: ${_APP_DOMAIN_FUNCTIONS}
  _APP_SMTP_HOST: ${_APP_SMTP_HOST}
  _APP_SMTP_PORT: ${_APP_SMTP_PORT}
  _APP_SMTP_SECURE: ${_APP_SMTP_SECURE}
  _APP_SMTP_USERNAME: ${_APP_SMTP_USERNAME}
  _APP_SMTP_PASSWORD: ${_APP_SMTP_PASSWORD}
  _APP_USAGE_STATS: ${_APP_USAGE_STATS}
  _APP_STORAGE_LIMIT: ${_APP_STORAGE_LIMIT}
  _APP_STORAGE_PREVIEW_LIMIT: ${_APP_STORAGE_PREVIEW_LIMIT}
  _APP_STORAGE_ANTIVIRUS: ${_APP_STORAGE_ANTIVIRUS}
  _APP_STORAGE_ANTIVIRUS_HOST: ${_APP_STORAGE_ANTIVIRUS_HOST}
  _APP_STORAGE_ANTIVIRUS_PORT: ${_APP_STORAGE_ANTIVIRUS_PORT}

services:
  appwrite:
    logging: *logging
    image: appwrite/appwrite:1.6.1
    volumes:
      - type: volume
        target: /storage/uploads
        source: appwrite-uploads
      - type: volume
        target: /storage/cache
        source: appwrite-cache
      - type: volume
        target: /storage/config
        source: appwrite-config
      - type: volume
        target: /storage/certificates
        source: appwrite-certificates
      - type: volume
        target: /storage/functions
        source: appwrite-functions
    depends_on:
      - mariadb
      - redis
    environment:
      <<: *env-console
      _APP_FUNCTIONS_SIZE_LIMIT: ${_APP_FUNCTIONS_SIZE_LIMIT}
      _APP_FUNCTIONS_TIMEOUT: ${_APP_FUNCTIONS_TIMEOUT}
      _APP_FUNCTIONS_BUILD_TIMEOUT: ${_APP_FUNCTIONS_BUILD_TIMEOUT}
      _APP_FUNCTIONS_CPUS: ${_APP_FUNCTIONS_CPUS}
      _APP_FUNCTIONS_MEMORY: ${_APP_FUNCTIONS_MEMORY}
      _APP_FUNCTIONS_RUNTIMES: ${_APP_FUNCTIONS_RUNTIMES}
      _APP_EXECUTOR_SECRET: ${_APP_EXECUTOR_SECRET}
      _APP_EXECUTOR_HOST: ${_APP_EXECUTOR_HOST}
      _APP_LOGGING_CONFIG: ${_APP_LOGGING_CONFIG}
      _APP_MAINTENANCE_INTERVAL: ${_APP_MAINTENANCE_INTERVAL}
      _APP_MAINTENANCE_DELAY: ${_APP_MAINTENANCE_DELAY}
      _APP_MAINTENANCE_RETENTION_EXECUTION: ${_APP_MAINTENANCE_RETENTION_EXECUTION}
      _APP_MAINTENANCE_RETENTION_CACHE: ${_APP_MAINTENANCE_RETENTION_CACHE}
      _APP_MAINTENANCE_RETENTION_ABUSE: ${_APP_MAINTENANCE_RETENTION_ABUSE}
      _APP_MAINTENANCE_RETENTION_AUDIT: ${_APP_MAINTENANCE_RETENTION_AUDIT}
      _APP_MAINTENANCE_RETENTION_USAGE_HOURLY: ${_APP_MAINTENANCE_RETENTION_USAGE_HOURLY}
      _APP_MAINTENANCE_RETENTION_SCHEDULES: ${_APP_MAINTENANCE_RETENTION_SCHEDULES}
      _APP_SMS_PROVIDER: ${_APP_SMS_PROVIDER}
      _APP_SMS_FROM: ${_APP_SMS_FROM}
      _APP_GRAPHQL_MAX_BATCH_SIZE: ${_APP_GRAPHQL_MAX_BATCH_SIZE}
      _APP_GRAPHQL_MAX_COMPLEXITY: ${_APP_GRAPHQL_MAX_COMPLEXITY}
      _APP_GRAPHQL_MAX_DEPTH: ${_APP_GRAPHQL_MAX_DEPTH}
      _APP_VCS_GITHUB_APP_NAME: ${_APP_VCS_GITHUB_APP_NAME}
      _APP_VCS_GITHUB_PRIVATE_KEY: ${_APP_VCS_GITHUB_PRIVATE_KEY}
      _APP_VCS_GITHUB_APP_ID: ${_APP_VCS_GITHUB_APP_ID}
      _APP_VCS_GITHUB_WEBHOOK_SECRET: ${_APP_VCS_GITHUB_WEBHOOK_SECRET}
      _APP_VCS_GITHUB_CLIENT_SECRET: ${_APP_VCS_GITHUB_CLIENT_SECRET}
      _APP_VCS_GITHUB_CLIENT_ID: ${_APP_VCS_GITHUB_CLIENT_ID}
      _APP_MIGRATIONS_FIREBASE_CLIENT_ID: ${_APP_MIGRATIONS_FIREBASE_CLIENT_ID}
      _APP_MIGRATIONS_FIREBASE_CLIENT_SECRET: ${_APP_MIGRATIONS_FIREBASE_CLIENT_SECRET}
      _APP_ASSISTANT_OPENAI_API_KEY: ${_APP_ASSISTANT_OPENAI_API_KEY}
    deploy:
      labels:
        zane.http.routes.0.domain: ${main_domain}
        zane.http.routes.0.base_path: /
        zane.http.routes.0.port: 80
        zane.http.routes.0.strip_prefix: "false"

  appwrite-console:
    logging: *logging
    image: appwrite/console:5.0.12
    environment:
      <<: *env-console
    deploy:
      labels:
        zane.http.routes.0.domain: ${main_domain}
        zane.http.routes.0.base_path: /console
        zane.http.routes.0.port: 80
        zane.http.routes.0.strip_prefix: "false"

  appwrite-realtime:
    logging: *logging
    image: appwrite/appwrite:1.6.1
    entrypoint: realtime
    depends_on:
      - mariadb
      - redis
    labels:
      - traefik.enable=true
      - traefik.constraint-label-stack=appwrite
    environment:
      <<: *env-core
      _APP_OPTIONS_ABUSE: ${_APP_OPTIONS_ABUSE}
      _APP_OPTIONS_ROUTER_PROTECTION: ${_APP_OPTIONS_ROUTER_PROTECTION}
      _APP_USAGE_STATS: ${_APP_USAGE_STATS}
      _APP_LOGGING_CONFIG: ${_APP_LOGGING_CONFIG}
    deploy:
      labels:
        zane.http.routes.0.domain: ${main_domain}
        zane.http.routes.0.base_path: /v1/realtime
        zane.http.routes.0.port: 80
        zane.http.routes.0.strip_prefix: "false"

  appwrite-worker-audits:
    logging: *logging
    image: appwrite/appwrite:1.6.1
    entrypoint: worker-audits
    restart: unless-stopped
    depends_on:
      - redis
      - mariadb
    environment:
      <<: *env-core
      _APP_LOGGING_CONFIG: ${_APP_LOGGING_CONFIG}

  appwrite-worker-webhooks:
    logging: *logging
    image: appwrite/appwrite:1.6.1
    entrypoint: worker-webhooks
    restart: unless-stopped
    depends_on:
      - redis
      - mariadb
    environment:
      <<: *env-core
      _APP_EMAIL_SECURITY: ${_APP_EMAIL_SECURITY}
      _APP_SYSTEM_SECURITY_EMAIL_ADDRESS: ${_APP_SYSTEM_SECURITY_EMAIL_ADDRESS}
      _APP_LOGGING_CONFIG: ${_APP_LOGGING_CONFIG}

  appwrite-worker-deletes:
    logging: *logging
    image: appwrite/appwrite:1.6.1
    entrypoint: worker-deletes
    restart: unless-stopped
    depends_on:
      - redis
      - mariadb
    volumes:
      - type: volume
        target: /storage/uploads
        source: appwrite-uploads
      - type: volume
        target: /storage/cache
        source: appwrite-cache
      - type: volume
        target: /storage/functions
        source: appwrite-functions
      - type: volume
        target: /storage/builds
        source: appwrite-builds
      - type: volume
        target: /storage/certificates
        source: appwrite-certificates
    environment:
      <<: *env-core-storage
      _APP_LOGGING_CONFIG: ${_APP_LOGGING_CONFIG}
      _APP_EXECUTOR_SECRET: ${_APP_EXECUTOR_SECRET}
      _APP_EXECUTOR_HOST: ${_APP_EXECUTOR_HOST}
      _APP_MAINTENANCE_RETENTION_ABUSE: ${_APP_MAINTENANCE_RETENTION_ABUSE}
      _APP_MAINTENANCE_RETENTION_AUDIT: ${_APP_MAINTENANCE_RETENTION_AUDIT}
      _APP_MAINTENANCE_RETENTION_EXECUTION: ${_APP_MAINTENANCE_RETENTION_EXECUTION}

  appwrite-worker-databases:
    logging: *logging
    image: appwrite/appwrite:1.6.1
    entrypoint: worker-databases
    restart: unless-stopped
    depends_on:
      - redis
      - mariadb
    environment:
      <<: *env-core
      _APP_LOGGING_CONFIG: ${_APP_LOGGING_CONFIG}

  appwrite-worker-builds:
    logging: *logging
    image: appwrite/appwrite:1.6.1
    entrypoint: worker-builds
    restart: unless-stopped
    depends_on:
      - redis
      - mariadb
    volumes:
      - type: volume
        target: /storage/functions
        source: appwrite-functions
      - type: volume
        target: /storage/builds
        source: appwrite-builds
    environment:
      <<: *env-core-storage
      _APP_EXECUTOR_SECRET: ${_APP_EXECUTOR_SECRET}
      _APP_EXECUTOR_HOST: ${_APP_EXECUTOR_HOST}
      _APP_LOGGING_CONFIG: ${_APP_LOGGING_CONFIG}
      _APP_VCS_GITHUB_APP_NAME: ${_APP_VCS_GITHUB_APP_NAME}
      _APP_VCS_GITHUB_PRIVATE_KEY: ${_APP_VCS_GITHUB_PRIVATE_KEY}
      _APP_VCS_GITHUB_APP_ID: ${_APP_VCS_GITHUB_APP_ID}
      _APP_FUNCTIONS_TIMEOUT: ${_APP_FUNCTIONS_TIMEOUT}
      _APP_FUNCTIONS_BUILD_TIMEOUT: ${_APP_FUNCTIONS_BUILD_TIMEOUT}
      _APP_FUNCTIONS_CPUS: ${_APP_FUNCTIONS_CPUS}
      _APP_FUNCTIONS_MEMORY: ${_APP_FUNCTIONS_MEMORY}
      _APP_FUNCTIONS_SIZE_LIMIT: ${_APP_FUNCTIONS_SIZE_LIMIT}
      _APP_OPTIONS_FORCE_HTTPS: ${_APP_OPTIONS_FORCE_HTTPS}
      _APP_OPTIONS_FUNCTIONS_FORCE_HTTPS: ${_APP_OPTIONS_FUNCTIONS_FORCE_HTTPS}
      _APP_DOMAIN: ${_APP_DOMAIN}

  appwrite-worker-certificates:
    logging: *logging
    image: appwrite/appwrite:1.6.1
    entrypoint: worker-certificates
    restart: unless-stopped
    depends_on:
      - redis
      - mariadb
    volumes:
      - type: volume
        target: /storage/config
        source: appwrite-config
      - type: volume
        target: /storage/certificates
        source: appwrite-certificates
    environment:
      <<: *env-core
      _APP_DOMAIN: ${_APP_DOMAIN}
      _APP_DOMAIN_TARGET: ${_APP_DOMAIN_TARGET}
      _APP_DOMAIN_FUNCTIONS: ${_APP_DOMAIN_FUNCTIONS}
      _APP_EMAIL_CERTIFICATES: ${_APP_EMAIL_CERTIFICATES}
      _APP_LOGGING_CONFIG: ${_APP_LOGGING_CONFIG}

  appwrite-worker-functions:
    logging: *logging
    image: appwrite/appwrite:1.6.1
    entrypoint: worker-functions
    restart: unless-stopped
    depends_on:
      - redis
      - mariadb
      - openruntimes-executor
    environment:
      <<: *env-core
      _APP_DOMAIN: ${_APP_DOMAIN}
      _APP_OPTIONS_FORCE_HTTPS: ${_APP_OPTIONS_FORCE_HTTPS}
      _APP_FUNCTIONS_TIMEOUT: ${_APP_FUNCTIONS_TIMEOUT}
      _APP_FUNCTIONS_BUILD_TIMEOUT: ${_APP_FUNCTIONS_BUILD_TIMEOUT}
      _APP_FUNCTIONS_CPUS: ${_APP_FUNCTIONS_CPUS}
      _APP_FUNCTIONS_MEMORY: ${_APP_FUNCTIONS_MEMORY}
      _APP_EXECUTOR_SECRET: ${_APP_EXECUTOR_SECRET}
      _APP_EXECUTOR_HOST: ${_APP_EXECUTOR_HOST}
      _APP_USAGE_STATS: ${_APP_USAGE_STATS}
      _APP_DOCKER_HUB_USERNAME: ${_APP_DOCKER_HUB_USERNAME}
      _APP_DOCKER_HUB_PASSWORD: ${_APP_DOCKER_HUB_PASSWORD}
      _APP_LOGGING_CONFIG: ${_APP_LOGGING_CONFIG}

  appwrite-worker-mails:
    logging: *logging
    image: appwrite/appwrite:1.6.1
    entrypoint: worker-mails
    restart: unless-stopped
    depends_on:
      - redis
    environment:
      <<: *env-core
      _APP_SYSTEM_EMAIL_NAME: ${_APP_SYSTEM_EMAIL_NAME}
      _APP_SYSTEM_EMAIL_ADDRESS: ${_APP_SYSTEM_EMAIL_ADDRESS}
      _APP_SMTP_HOST: ${_APP_SMTP_HOST}
      _APP_SMTP_PORT: ${_APP_SMTP_PORT}
      _APP_SMTP_SECURE: ${_APP_SMTP_SECURE}
      _APP_SMTP_USERNAME: ${_APP_SMTP_USERNAME}
      _APP_SMTP_PASSWORD: ${_APP_SMTP_PASSWORD}
      _APP_LOGGING_CONFIG: ${_APP_LOGGING_CONFIG}

  appwrite-worker-messaging:
    logging: *logging
    image: appwrite/appwrite:1.6.1
    entrypoint: worker-messaging
    restart: unless-stopped
    volumes:
      - type: volume
        target: /storage/uploads
        source: appwrite-uploads
    depends_on:
      - redis
    environment:
      <<: *env-core-storage
      _APP_LOGGING_CONFIG: ${_APP_LOGGING_CONFIG}
      _APP_SMS_FROM: ${_APP_SMS_FROM}
      _APP_SMS_PROVIDER: ${_APP_SMS_PROVIDER}

  appwrite-worker-migrations:
    logging: *logging
    image: appwrite/appwrite:1.6.1
    entrypoint: worker-migrations
    restart: unless-stopped
    depends_on:
      - mariadb
    environment:
      <<: *env-core
      _APP_DOMAIN: ${_APP_DOMAIN}
      _APP_DOMAIN_TARGET: ${_APP_DOMAIN_TARGET}
      _APP_EMAIL_SECURITY: ${_APP_EMAIL_SECURITY}
      _APP_LOGGING_CONFIG: ${_APP_LOGGING_CONFIG}
      _APP_MIGRATIONS_FIREBASE_CLIENT_ID: ${_APP_MIGRATIONS_FIREBASE_CLIENT_ID}
      _APP_MIGRATIONS_FIREBASE_CLIENT_SECRET: ${_APP_MIGRATIONS_FIREBASE_CLIENT_SECRET}

  appwrite-task-maintenance:
    logging: *logging
    image: appwrite/appwrite:1.6.1
    entrypoint: maintenance
    restart: unless-stopped
    depends_on:
      - redis
    environment:
      <<: *env-core
      _APP_DOMAIN: ${_APP_DOMAIN}
      _APP_DOMAIN_TARGET: ${_APP_DOMAIN_TARGET}
      _APP_DOMAIN_FUNCTIONS: ${_APP_DOMAIN_FUNCTIONS}
      _APP_MAINTENANCE_INTERVAL: ${_APP_MAINTENANCE_INTERVAL}
      _APP_MAINTENANCE_RETENTION_EXECUTION: ${_APP_MAINTENANCE_RETENTION_EXECUTION}
      _APP_MAINTENANCE_RETENTION_CACHE: ${_APP_MAINTENANCE_RETENTION_CACHE}
      _APP_MAINTENANCE_RETENTION_ABUSE: ${_APP_MAINTENANCE_RETENTION_ABUSE}
      _APP_MAINTENANCE_RETENTION_AUDIT: ${_APP_MAINTENANCE_RETENTION_AUDIT}
      _APP_MAINTENANCE_RETENTION_USAGE_HOURLY: ${_APP_MAINTENANCE_RETENTION_USAGE_HOURLY}
      _APP_MAINTENANCE_RETENTION_SCHEDULES: ${_APP_MAINTENANCE_RETENTION_SCHEDULES}

  appwrite-worker-usage:
    logging: *logging
    image: appwrite/appwrite:1.6.1
    entrypoint: worker-usage
    restart: unless-stopped
    depends_on:
      - redis
      - mariadb
    environment:
      <<: *env-core
      _APP_USAGE_STATS: ${_APP_USAGE_STATS}
      _APP_LOGGING_CONFIG: ${_APP_LOGGING_CONFIG}
      _APP_USAGE_AGGREGATION_INTERVAL: ${_APP_USAGE_AGGREGATION_INTERVAL}

  appwrite-worker-usage-dump:
    logging: *logging
    image: appwrite/appwrite:1.6.1
    entrypoint: worker-usage-dump
    depends_on:
      - redis
      - mariadb
    environment:
      <<: *env-core
      _APP_USAGE_STATS: ${_APP_USAGE_STATS}
      _APP_LOGGING_CONFIG: ${_APP_LOGGING_CONFIG}
      _APP_USAGE_AGGREGATION_INTERVAL: ${_APP_USAGE_AGGREGATION_INTERVAL}

  appwrite-scheduler-functions:
    logging: *logging
    image: appwrite/appwrite:1.6.1
    entrypoint: schedule-functions
    restart: unless-stopped
    depends_on:
      - mariadb
      - redis
    environment:
      <<: *env-core

  appwrite-scheduler-executions:
    logging: *logging
    image: appwrite/appwrite:1.6.1
    entrypoint: schedule-executions
    restart: unless-stopped
    depends_on:
      - mariadb
      - redis
    environment:
      <<: *env-core

  appwrite-scheduler-messages:
    logging: *logging
    image: appwrite/appwrite:1.6.1
    entrypoint: schedule-messages
    restart: unless-stopped
    depends_on:
      - mariadb
      - redis
    environment:
      <<: *env-core

  appwrite-assistant:
    logging: *logging
    image: appwrite/assistant:0.4.0
    restart: unless-stopped
    environment:
      _APP_ASSISTANT_OPENAI_API_KEY: ${_APP_ASSISTANT_OPENAI_API_KEY}

  openruntimes-executor:
    logging: *logging
    hostname: exc1
    restart: unless-stopped
    stop_signal: SIGINT
    image: openruntimes/executor:0.6.11
    volumes:
      - type: bind
        target: /var/run/docker.sock
        source: /var/run/docker.sock
      - type: volume
        target: /storage/builds
        source: appwrite-builds
      - type: volume
        target: /storage/functions
        source: appwrite-functions
      - type: bind
        target: /tmp
        source: /tmp
    environment:
      OPR_EXECUTOR_INACTIVE_TRESHOLD: ${_APP_FUNCTIONS_INACTIVE_THRESHOLD}
      OPR_EXECUTOR_MAINTENANCE_INTERVAL: ${_APP_FUNCTIONS_MAINTENANCE_INTERVAL}
      OPR_EXECUTOR_NETWORK: ${_APP_FUNCTIONS_RUNTIMES_NETWORK}
      OPR_EXECUTOR_DOCKER_HUB_USERNAME: ${_APP_DOCKER_HUB_USERNAME}
      OPR_EXECUTOR_DOCKER_HUB_PASSWORD: ${_APP_DOCKER_HUB_PASSWORD}
      OPR_EXECUTOR_ENV: ${_APP_ENV}
      OPR_EXECUTOR_RUNTIMES: ${_APP_FUNCTIONS_RUNTIMES}
      OPR_EXECUTOR_SECRET: ${_APP_EXECUTOR_SECRET}
      OPR_EXECUTOR_LOGGING_CONFIG: ${_APP_LOGGING_CONFIG}
      OPR_EXECUTOR_STORAGE_DEVICE: ${_APP_STORAGE_DEVICE}
      OPR_EXECUTOR_STORAGE_S3_ACCESS_KEY: ${_APP_STORAGE_S3_ACCESS_KEY}
      OPR_EXECUTOR_STORAGE_S3_SECRET: ${_APP_STORAGE_S3_SECRET}
      OPR_EXECUTOR_STORAGE_S3_REGION: ${_APP_STORAGE_S3_REGION}
      OPR_EXECUTOR_STORAGE_S3_BUCKET: ${_APP_STORAGE_S3_BUCKET}
      OPR_EXECUTOR_STORAGE_DO_SPACES_ACCESS_KEY: ${_APP_STORAGE_DO_SPACES_ACCESS_KEY}
      OPR_EXECUTOR_STORAGE_DO_SPACES_SECRET: ${_APP_STORAGE_DO_SPACES_SECRET}
      OPR_EXECUTOR_STORAGE_DO_SPACES_REGION: ${_APP_STORAGE_DO_SPACES_REGION}
      OPR_EXECUTOR_STORAGE_DO_SPACES_BUCKET: ${_APP_STORAGE_DO_SPACES_BUCKET}
      OPR_EXECUTOR_STORAGE_BACKBLAZE_ACCESS_KEY: ${_APP_STORAGE_BACKBLAZE_ACCESS_KEY}
      OPR_EXECUTOR_STORAGE_BACKBLAZE_SECRET: ${_APP_STORAGE_BACKBLAZE_SECRET}
      OPR_EXECUTOR_STORAGE_BACKBLAZE_REGION: ${_APP_STORAGE_BACKBLAZE_REGION}
      OPR_EXECUTOR_STORAGE_BACKBLAZE_BUCKET: ${_APP_STORAGE_BACKBLAZE_BUCKET}
      OPR_EXECUTOR_STORAGE_LINODE_ACCESS_KEY: ${_APP_STORAGE_LINODE_ACCESS_KEY}
      OPR_EXECUTOR_STORAGE_LINODE_SECRET: ${_APP_STORAGE_LINODE_SECRET}
      OPR_EXECUTOR_STORAGE_LINODE_REGION: ${_APP_STORAGE_LINODE_REGION}
      OPR_EXECUTOR_STORAGE_LINODE_BUCKET: ${_APP_STORAGE_LINODE_BUCKET}
      OPR_EXECUTOR_STORAGE_WASABI_ACCESS_KEY: ${_APP_STORAGE_WASABI_ACCESS_KEY}
      OPR_EXECUTOR_STORAGE_WASABI_SECRET: ${_APP_STORAGE_WASABI_SECRET}
      OPR_EXECUTOR_STORAGE_WASABI_REGION: ${_APP_STORAGE_WASABI_REGION}
      OPR_EXECUTOR_STORAGE_WASABI_BUCKET: ${_APP_STORAGE_WASABI_BUCKET}

  mariadb:
    logging: *logging
    image: mariadb:10.11
    restart: unless-stopped
    volumes:
      - type: volume
        target: /var/lib/mysql
        source: appwrite-mariadb
    environment:
      MYSQL_ROOT_PASSWORD: ${_APP_DB_ROOT_PASS}
      MYSQL_DATABASE: ${_APP_DB_SCHEMA}
      MYSQL_USER: ${_APP_DB_USER}
      MYSQL_PASSWORD: ${_APP_DB_PASS}
      MARIADB_AUTO_UPGRADE: "1"
    command: mysqld --innodb-flush-method=fsync

  redis:
    logging: *logging
    image: redis:7.2.4-alpine
    restart: unless-stopped
    command: >
      redis-server --maxmemory 512mb --maxmemory-policy allkeys-lru --maxmemory-samples 5
    volumes:
      - type: volume
        target: /data
        source: appwrite-redis

volumes:
  appwrite-mariadb:
  appwrite-redis:
  appwrite-cache:
  appwrite-uploads:
  appwrite-certificates:
  appwrite-functions:
  appwrite-builds:
  appwrite-config:
